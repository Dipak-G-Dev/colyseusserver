{"version":3,"file":"index.js","sources":["../src/index.ts"],"sourcesContent":["import redis, { RedisClient, ClientOpts } from 'redis';\nimport { promisify } from 'util';\n\nimport {\n  IRoomListingData,\n  MatchMakerDriver,\n  QueryHelpers,\n  RoomListingData,\n} from '@colyseus/core';\n\nimport { Query } from './Query';\nimport { RoomData } from './RoomData';\n\nexport class RedisDriver implements MatchMakerDriver {\n  private readonly _client: RedisClient;\n  private readonly hgetall: (key: string) => Promise<{ [key: string]: string }>;\n\n  constructor(options?: ClientOpts, key: string = 'roomcaches') {\n    this._client = redis.createClient(options);\n    this.hgetall = promisify(this._client.hgetall).bind(this._client);\n  }\n\n  public createInstance(initialValues: any = {}) {\n    return new RoomData(initialValues, this._client);\n  }\n\n  public async find(conditions: any) {\n    const rooms = await this.getRooms();\n    return rooms.filter((room) => {\n      if (!room.roomId) {\n        return false;\n      }\n\n      for (const field in conditions) {\n        if (\n          conditions.hasOwnProperty(field) &&\n          room[field] !== conditions[field]\n        ) {\n          return false;\n        }\n      }\n      return true;\n    });\n  }\n\n  public findOne(conditions: Partial<IRoomListingData>): QueryHelpers<RoomListingData> {\n    return (new Query<RoomListingData>(this.getRooms(), conditions) as any) as QueryHelpers<RoomListingData>;\n  }\n\n  public async getRooms() {\n    return Object.entries(await this.hgetall('roomcaches') ?? []).map(\n      ([, roomcache]) => new RoomData(JSON.parse(roomcache), this._client)\n    );\n  }\n\n  public clear() {\n    this._client.del('roomcaches');\n  }\n\n  public shutdown() {\n    this._client.quit();\n  }\n}\n"],"names":["redis","promisify","RoomData","Query"],"mappings":";;;;;;;;;;;;;MAaa,WAAW;IACL,OAAO,CAAc;IACrB,OAAO,CAAsD;IAE9E,YAAY,OAAoB,EAAE,MAAc,YAAY;QAC1D,IAAI,CAAC,OAAO,GAAGA,yBAAK,CAAC,YAAY,CAAC,OAAO,CAAC,CAAC;QAC3C,IAAI,CAAC,OAAO,GAAGC,cAAS,CAAC,IAAI,CAAC,OAAO,CAAC,OAAO,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;KACnE;IAEM,cAAc,CAAC,gBAAqB,EAAE;QAC3C,OAAO,IAAIC,iBAAQ,CAAC,aAAa,EAAE,IAAI,CAAC,OAAO,CAAC,CAAC;KAClD;IAEM,MAAM,IAAI,CAAC,UAAe;QAC/B,MAAM,KAAK,GAAG,MAAM,IAAI,CAAC,QAAQ,EAAE,CAAC;QACpC,OAAO,KAAK,CAAC,MAAM,CAAC,CAAC,IAAI;YACvB,IAAI,CAAC,IAAI,CAAC,MAAM,EAAE;gBAChB,OAAO,KAAK,CAAC;aACd;YAED,KAAK,MAAM,KAAK,IAAI,UAAU,EAAE;gBAC9B,IACE,UAAU,CAAC,cAAc,CAAC,KAAK,CAAC;oBAChC,IAAI,CAAC,KAAK,CAAC,KAAK,UAAU,CAAC,KAAK,CAAC,EACjC;oBACA,OAAO,KAAK,CAAC;iBACd;aACF;YACD,OAAO,IAAI,CAAC;SACb,CAAC,CAAC;KACJ;IAEM,OAAO,CAAC,UAAqC;QAClD,OAAQ,IAAIC,WAAK,CAAkB,IAAI,CAAC,QAAQ,EAAE,EAAE,UAAU,CAA0C,CAAC;KAC1G;IAEM,MAAM,QAAQ;QACnB,OAAO,MAAM,CAAC,OAAO,CAAC,MAAM,IAAI,CAAC,OAAO,CAAC,YAAY,CAAC,IAAI,EAAE,CAAC,CAAC,GAAG,CAC/D,CAAC,GAAG,SAAS,CAAC,KAAK,IAAID,iBAAQ,CAAC,IAAI,CAAC,KAAK,CAAC,SAAS,CAAC,EAAE,IAAI,CAAC,OAAO,CAAC,CACrE,CAAC;KACH;IAEM,KAAK;QACV,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,YAAY,CAAC,CAAC;KAChC;IAEM,QAAQ;QACb,IAAI,CAAC,OAAO,CAAC,IAAI,EAAE,CAAC;KACrB;;;;;"}