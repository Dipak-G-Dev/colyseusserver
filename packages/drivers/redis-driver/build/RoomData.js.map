{"version":3,"file":"RoomData.js","sources":["../src/RoomData.ts"],"sourcesContent":["import { RoomListingData } from '@colyseus/core';\nimport { RedisClient } from 'redis';\n\nexport class RoomData implements RoomListingData {\n  public clients: number = 0;\n  public locked: boolean = false;\n  public private: boolean = false;\n  public maxClients: number = Infinity;\n  public metadata: any;\n  public name: string;\n  public processId: string;\n  public roomId: string;\n  public createdAt: Date;\n  public unlisted: boolean = false;\n\n  #client: RedisClient;\n\n  constructor(\n    initialValues: any,\n    client: RedisClient\n  ) {\n    this.#client = client;\n\n    this.createdAt = initialValues.createdAt\n      ? new Date(initialValues.createdAt)\n      : new Date();\n\n    for (const field in initialValues) {\n      if (initialValues.hasOwnProperty(field)) {\n        this[field] = initialValues[field];\n      }\n    }\n  }\n\n  public toJSON() {\n    return {\n      clients: this.clients,\n      createdAt: this.createdAt,\n      maxClients: this.maxClients,\n      metadata: this.metadata,\n      name: this.name,\n      processId: this.processId,\n      roomId: this.roomId,\n    };\n  }\n\n  public async save() {\n    if (this.roomId) {\n      // FIXME: workaround so JSON.stringify() stringifies all dynamic fields.\n      const toJSON = this.toJSON;\n      this.toJSON = undefined;\n\n      const roomcache = JSON.stringify(this);\n      this.toJSON = toJSON;\n\n      await this.hset('roomcaches', this.roomId, roomcache);\n\n    } else {\n      console.warn(\"⚠️ RedisDriver: can't .save() without a `roomId`\")\n    }\n  }\n\n  public updateOne(operations: any) {\n    if (operations.$set) {\n      for (const field in operations.$set) {\n        if (operations.$set.hasOwnProperty(field)) {\n          this[field] = operations.$set[field];\n        }\n      }\n    }\n\n    if (operations.$inc) {\n      for (const field in operations.$inc) {\n        if (operations.$inc.hasOwnProperty(field)) {\n          this[field] += operations.$inc[field];\n        }\n      }\n    }\n\n    return this.save();\n  }\n\n  public remove() {\n    if (this.roomId) {\n      return this.hdel('roomcaches', this.roomId);\n    }\n  }\n\n  private hset(key: string, field: string, value: string) {\n    return new Promise((resolve, reject) => {\n      this.#client.hset(key, field, value, function (err, res) {\n        if (err) {\n          return reject(err);\n        }\n        resolve(res);\n      });\n    });\n  }\n\n  private hdel(key: string, field: string) {\n    return new Promise((resolve, reject) => {\n      this.#client.hdel(key, field, function (err, res) {\n        if (err) {\n          return reject(err);\n        }\n        resolve(res);\n      });\n    });\n  }\n}\n"],"names":[],"mappings":"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"}